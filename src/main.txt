import os
import re

output_file = "_Código.txt"
ENCODINGS_TO_TRY = ["utf-8", "utf-8-sig", "cp1252", "latin-1"]

def is_binary_file(path, bytes_to_check=1024):
    """Chequea si un archivo parece binario leyendo sus primeros bytes."""
    try:
        with open(path, "rb") as f:
            chunk = f.read(bytes_to_check)
            if b'\x00' in chunk:
                return True
            # Heurística simple: si hay muchos bytes fuera de rango ASCII, no es binario necesariamente.
            return False
    except Exception:
        return True

def read_text_file(path):
    """Intenta leer un archivo probando varias codificaciones. Lanza excepción si no es legible."""
    if is_binary_file(path):
        raise UnicodeDecodeError("binary", b"", 0, 1, "archivo binario detectado")

    last_exc = None
    for enc in ENCODINGS_TO_TRY:
        try:
            with open(path, "r", encoding=enc) as f:
                return f.read()
        except Exception as e:
            last_exc = e
            continue
    # Si todas fallaron, lanzar la última excepción para informar
    raise last_exc if last_exc is not None else UnicodeDecodeError("unknown", b"", 0, 1, "no se pudo leer")

def limpiar_html(content):
    """Elimina las secciones <style>...</style> de un archivo HTML."""
    return re.sub(r'<style\b[^>]*>.*?</style>', '', content, flags=re.DOTALL | re.IGNORECASE)

def generate_tree(start_path, include_test, include_html):
    """Genera una vista tipo árbol desde start_path"""
    tree_lines = []
    for root, dirs, files in os.walk(start_path):
        # Omitir carpeta 'test' si no se incluye
        if 'test' in dirs and not include_test:
            dirs.remove('test')
        
        # Filtrar archivos según configuración y excluir main.py
        files = [f for f in files if f != "main.py"]
        if 'resources' in root and not include_html:
            files = [f for f in files if not f.endswith('.html')]
        
        dirs.sort()
        files.sort()

        level = root.replace(start_path, '').count(os.sep)
        indent = '│ ' * level + '├───' if level > 0 else ''
        
        dirname = os.path.basename(root) or os.path.abspath(root)
        if level > 0:
            tree_lines.append(f"{indent}{dirname}")
        
        for f in files:
            if not f.endswith(".css"):
                sub_indent = '│ ' * (level + 1)
                tree_lines.append(f"{sub_indent}{f}")
    
    return "\n".join(tree_lines)

def process_files(start_path, include_test, include_html):
    """Lee todos los archivos (excepto .css y main.py) y devuelve bloques formateados.
       Imprime en consola el estado por archivo."""
    code_blocks = []
    
    for root, dirs, files in os.walk(start_path):
        if 'test' in dirs and not include_test:
            dirs.remove('test')
        
        files = [f for f in files if f != "main.py"]
        if 'resources' in root and not include_html:
            files = [f for f in files if not f.endswith('.html')]

        for file in sorted(files):
            if file.endswith(".css"):
                print(f"[SKIP] {file}: archivo .css excluido.")
                continue
            
            file_path = os.path.join(root, file)
            relative_path = os.path.relpath(file_path, start_path).replace("\\", "/")
            
            try:
                content = read_text_file(file_path)
                if file.endswith(".html"):
                    content = limpiar_html(content)
                block = f"### {relative_path}\n'''\n{content}\n'''\n"
                code_blocks.append(block)
                print(f"[OK] {relative_path}: leído correctamente.")
            except UnicodeDecodeError as e:
                print(f"[SKIP] {relative_path}: no es archivo de texto o codificación no soportada ({e}).")
            except Exception as e:
                print(f"[ERROR] {relative_path}: error al leer ({e}).")
    
    return "\n".join(code_blocks)

def ask_user_for_inclusion():
    include_test = input("¿Deseas incluir los archivos dentro de la carpeta 'test'? (y/n): ").strip().lower() == 'y'
    include_html = input("¿Deseas incluir los archivos .html dentro de la carpeta 'resources'? (y/n): ").strip().lower() == 'y'
    return include_test, include_html

def main():
    start_path = os.getcwd()
    
    include_test, include_html = ask_user_for_inclusion()
    
    tree_output = generate_tree(start_path, include_test, include_html)
    files_output = process_files(start_path, include_test, include_html)
    
    with open(os.path.join(start_path, output_file), 'w', encoding='utf-8') as f:
        f.write(tree_output + "\n\n" + files_output)
    
    print(f"Archivo '{output_file}' generado correctamente.")

if __name__ == "__main__":
    main()
