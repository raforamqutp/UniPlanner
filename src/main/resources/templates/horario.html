<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Horario - UNIplanner</title>

<style>
body {
  font-family: "Segoe UI", Roboto, sans-serif;
  background-color: #f7f9fc;
  margin: 0;
  padding: 0;
}

nav {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: #1e3a8a;
  padding: 0.8rem;
  flex-wrap: wrap;
}

nav a {
  color: white;
  text-decoration: none;
  font-size: 0.95rem;
  font-weight: 500;
  padding: 0.5rem 0.8rem;
  transition: background 0.2s ease;
  border-radius: 6px;
}

nav a:hover {
  background: rgba(255, 255, 255, 0.15);
}

.header {
  text-align: center;
  padding: 1rem;
  color: #1e3a8a;
}

.actions {
  text-align: center;
  margin: 1rem;
}

.btn {
  padding: 0.75rem 1.5rem;
  background-color: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.2s;
  margin: 0 0.5rem;
}

.btn:hover {
  background-color: #dc2626;
}

.btn-success {
  background-color: #10b981;
}

.btn-success:hover {
  background-color: #059669;
}

.schedule-container {
  max-width: 100%;
  overflow-x: auto;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  padding: 20px;
  margin: 1rem;
}

.schedule-grid {
  display: grid;
  grid-template-columns: 120px repeat(7, 1fr);
  gap: 1px;
  background-color: #e9ecef;
  border: 1px solid #e9ecef;
}

.schedule-corner, 
.schedule-header, 
.schedule-time, 
.schedule-cell {
  padding: 10px;
  background-color: white;
}

.schedule-header {
  font-weight: bold;
  text-align: center;
  background-color: #f8f9fa;
  position: sticky;
  top: 0;
}

.schedule-time {
  font-size: 0.85rem;
  color: #495057;
  border-right: 1px solid #e9ecef;
  display: flex;
  align-items: center;
}

.schedule-cell {
  position: relative;
  min-height: 40px;
  transition: background-color 0.2s;
}

.schedule-cell:hover {
  background-color: #f8f9fa;
}

.bold-hour {
  font-weight: bold;
}

.course-block {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 4px;
  padding: 8px;
  margin: 2px;
  font-size: 0.75rem;
  border-left: 4px solid #4f46e5;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  position: absolute;
  top: 2px;
  left: 2px;
  right: 2px;
  bottom: 2px;
  z-index: 1;
}

.course-block:hover {
  transform: scale(1.02);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 2;
}

.course-time {
  font-size: 0.7rem;
  opacity: 0.9;
  margin-top: 2px;
}

@media (max-width: 768px) {
  .schedule-grid {
    grid-template-columns: 80px repeat(7, 1fr);
    font-size: 0.8rem;
  }
  
  .schedule-corner, 
  .schedule-header, 
  .schedule-time, 
  .schedule-cell {
    padding: 5px;
  }
}
</style>
</head>
<body>

<nav>
    <a th:href="@{/cursos}">Volver a Cursos</a>
    <a th:href="@{/horario}">Actualizar Horario</a>
</nav>

<div class="header">
    <h1>Mi Horario</h1>
    <p id="statusMessage">Cargando horario...</p>
</div>

<div class="actions">
    <button class="btn" onclick="limpiarHorario()">Limpiar Horario</button>
    <button class="btn btn-success" onclick="actualizarDesdeBackend()">Actualizar desde Servidor</button>
</div>

<div class="schedule-container">
    <div class="schedule-grid" id="scheduleGrid"></div>
</div>

<script>
class HorarioManager {
  constructor() {
    // Días corregidos (con tildes)
    this.dias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
    this.horas = this.generarHoras();
    this.grid = document.getElementById('scheduleGrid');
    this.crearEstructuraBase();
    this.cargarBloquesIniciales();
  }

  actualizarEstado(msg) {
    const el = document.getElementById("statusMessage");
    if (el) el.textContent = msg;
  }

  generarHoras() {
    const horas = [];
    for (let h = 7; h <= 22; h++) {
      for (let m = 0; m < 60; m += 30) {
        const hi = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        const nh = m === 30 ? h + 1 : h;
        const nm = m === 30 ? 0 : 30;
        const hf = `${String(nh).padStart(2, '0')}:${String(nm).padStart(2, '0')}`;
        horas.push({ inicio: hi, fin: hf, display: `${hi} - ${hf}` });
      }
    }
    return horas;
  }

  crearEstructuraBase() {
    this.grid.innerHTML = "";
    this.grid.appendChild(this.crearCelda("schedule-corner", "Hora \\ Día"));
    this.dias.forEach(d => this.grid.appendChild(this.crearCelda("schedule-header", d)));
    this.horas.forEach((hora, i) => {
      const clase = hora.inicio.endsWith(":00") ? "schedule-time bold-hour" : "schedule-time";
      this.grid.appendChild(this.crearCelda(clase, hora.display));
      this.dias.forEach(() => this.grid.appendChild(this.crearCelda("schedule-cell", "")));
    });
  }

  crearCelda(clase, contenido) {
    const div = document.createElement("div");
    div.className = clase;
    div.textContent = contenido;
    return div;
  }

  formatearHora(hora) {
    if (!hora) return hora;
    if (hora.match(/^\d{2}:\d{2}:\d{2}$/)) return hora.slice(0,5);
    if (hora.match(/^\d{1,2}:\d{2}$/)) {
      const [h,m] = hora.split(":");
      return `${h.padStart(2,"0")}:${m}`;
    }
    return hora;
  }

  async cargarBloquesIniciales() {
    this.actualizarEstado("Cargando horario...");
    try {
      const resp = await fetch("/horario/api");
      const data = await resp.json();
      console.log("Bloques recibidos:", data);
      if (data.bloques?.length > 0) {
        this.cargarBloques(data.bloques);
        this.actualizarEstado(`Horario cargado (${data.bloques.length} cursos)`);
      } else {
        this.actualizarEstado("No hay cursos asignados al horario");
      }
    } catch (e) {
      console.error("Error al cargar horario:", e);
      this.actualizarEstado("Error al conectar con el servidor");
    }
  }

  cargarBloques(bloques) {
    this.limpiarVisual();
    bloques.forEach(b => {
      const bloque = {
        ...b,
        horaInicio: this.formatearHora(b.horaInicio),
        horaFin: this.formatearHora(b.horaFin)
      };
      this.marcarBloque(bloque);
    });
  }

  encontrarIndiceCelda(dia, horaInicio) {
    const diaIndex = this.dias.indexOf(dia);
    const horaIndex = this.horas.findIndex(h => h.inicio === horaInicio);
    if (diaIndex === -1 || horaIndex === -1) return -1;
    return 1 + (horaIndex * 8) + diaIndex + 1;
  }

  marcarBloque(b) {
    const inicio = this.horas.findIndex(h => h.inicio === b.horaInicio);
    const fin = this.horas.findIndex(h => h.inicio === b.horaFin);
    if (inicio === -1 || fin === -1 || fin <= inicio) return;

    for (let i = inicio; i < fin; i++) {
      const celdaIdx = this.encontrarIndiceCelda(b.dia, this.horas[i].inicio);
      const celda = this.grid.children[celdaIdx];
      if (!celda) continue;
      celda.innerHTML = "";
      const block = document.createElement("div");
      block.className = "course-block";
      if (i === inicio) {
        block.innerHTML = `<strong>${b.nombre}</strong><div class="course-time">${b.horaInicio} - ${b.horaFin}</div>`;
        block.title = `${b.nombre}\n${b.dia} ${b.horaInicio}-${b.horaFin}`;
      }
      celda.appendChild(block);
    }
  }

  limpiarVisual() {
    this.crearEstructuraBase();
  }
}

let horarioManager;
document.addEventListener("DOMContentLoaded", () => {
  horarioManager = new HorarioManager();
});

function actualizarDesdeBackend() {
  horarioManager.actualizarEstado("Actualizando...");
  horarioManager.cargarBloquesIniciales();
}

function limpiarHorario() {
  if (!confirm("¿Seguro que deseas limpiar el horario?")) return;
  fetch("/horario/api/clear", { method: "DELETE" })
    .then(resp => {
      if (resp.ok) {
        horarioManager.limpiarVisual();
        horarioManager.actualizarEstado("Horario limpiado");
      } else {
        alert("Error al limpiar el horario");
      }
    })
    .catch(() => alert("Error al conectar con el servidor"));
}
</script>
</body>
</html>
