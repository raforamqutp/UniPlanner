<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title th:text="${titulo}">Cursos</title>
    <style>
        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: #f7f9fc;
            margin: 0;
            padding: 0;
        }

        nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #1e3a8a;
            padding: 0.8rem;
            flex-wrap: wrap;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            padding: 0.5rem 0.8rem;
            transition: background 0.2s ease;
            border-radius: 6px;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        header {
            text-align: center;
            padding: 1rem;
            color: #1e3a8a;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.15);
        }

        .curso-nombre {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e3a8a;
        }

        .ciclo {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 1rem;
        }

        .seccion {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-left: 3px solid #1e3a8a;
            background-color: #f1f5f9;
            border-radius: 6px;
            position: relative;
        }

        .seccion-checkbox {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            transform: scale(1.2);
        }

        .seccion.selected {
            border-left-color: #10b981;
            background-color: #d1fae5;
        }

        .docente {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.3rem;
        }

        .horario {
            font-size: 0.85rem;
            color: #555;
            margin: 0;
        }

        .actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background-color: #1e3a8a;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #1e40af;
        }

        .btn-success {
            background-color: #10b981;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        /* Responsive */
        @media (max-width: 600px) {
            nav {
                flex-direction: column;
                align-items: stretch;
            }
            nav a {
                text-align: center;
                padding: 0.8rem;
                width: 100%;
            }
            .actions {
                position: static;
                justify-content: center;
                margin: 1rem;
            }
        }
		.actions {
		    padding: 10px;
		    margin-bottom: 10px;
		  }
		  .btn {
		    padding: 8px 12px;
		    font-size: 0.9rem;
		    border: none;
		    border-radius: 4px;
		    cursor: pointer;
		    margin-right: 5px;
		  }
		  .btn-success {
		    color: #fff;
		    background-color: #28a745;
		  }
		  #form-bloque-personalizado {
		    margin-top: 15px;
		    padding: 15px;
		    background: #f9f9f9;
		    border-radius: 8px;
		    border: 1px solid #eee;
		  }
		  #form-bloque-personalizado input,
		  #form-bloque-personalizado select {
		    margin-right: 10px;
		    padding: 8px;
		    border: 1px solid #ccc;
		    border-radius: 4px;
		  }
    </style>
</head>

<body>
<nav>
  <a th:href="@{/cursos}">Volver a Cursos</a>
  <a th:href="@{/horario}">Actualizar Horario</a>
</nav>

<div class="header">
  <h1>Mi Horario</h1>
  <p id="statusMessage">Cargando horario...</p>
</div>

<div class="actions">
  <button class="btn" onclick="limpiarHorario()">Limpiar Horario</button>
  <button class="btn btn-success" onclick="actualizarDesdeBackend()">Actualizar desde Servidor</button>
  <button class="btn" onclick="toggleDebug()">Mostrar Debug</button>
</div>

<form id="form-bloque-personalizado" class="actions">
    <strong>Añadir Bloque Personalizado:</strong>
    <input type="text" id="bloque-nombre" placeholder="Nombre (ej. Almuerzo)" required>
    <select id="bloque-dia" required>
        <option value="Lunes">Lunes</option>
        <option value="Martes">Martes</option>
        <option value="Miercoles">Miércoles</option>
        <option value="Jueves">Jueves</option>
        <option value="Viernes">Viernes</option>
        <option value="Sabado">Sábado</option>
    </select>
    <input type="time" id="bloque-inicio" step="1800" required>
    <input type="time" id="bloque-fin" step="1800" required>
    <button type="submit" class="btn">Añadir Bloque</button>
</form>
<div id="debugPanel" class="debug-info" style="display:none;">
  <h3>Información de Debug</h3>
  <div id="debugContent"></div>
</div>

<div class="schedule-container">
  <div class="schedule-grid" id="scheduleGrid"></div>
</div>

<script>
class HorarioManager {
  // ... (TODA LA CLASE HorarioManager ES IDÉNTICA) ...
  constructor() {
    this.daysCanonical = ["Lunes","Martes","Miercoles","Jueves","Viernes","Sabado","Domingo"];
    this.grid = document.getElementById('scheduleGrid');
    this.times = this._generarSlots("07:00", "22:00", 30);
    this.debugContent = document.getElementById('debugContent');
    this._buildGrid();
    this._loadFromApi();
  }

  _log(...args){ 
    console.log(...args); 
    if(this.debugContent) {
      this.debugContent.innerHTML += args.join(' ') + '<br>';
    }
  }

  _generarSlots(start, end, stepMin){
    const parse = t=>{ 
        const [h,m]=t.split(':').map(Number); 
        return h*60+m; 
    };
    const pad = n => String(n).padStart(2,'0');
    const slots=[];
    let cur = parse(start);
    const endM = parse(end);
    while(cur < endM){
      const next = cur + stepMin;
      const hh = pad(Math.floor(cur/60)); 
      const mm = pad(cur%60);
      const nh = pad(Math.floor(next/60)); 
      const nm = pad(next%60);
      slots.push({ 
          time: `${hh}:${mm}`, 
          display: `${hh}:${mm} - ${nh}:${nm}`, 
          startM: cur,
          endM: next
      });
      cur = next;
    }
    return slots;
  }

  _normalizeDay(d){
    if(!d) return d;
    const lower = d.toLowerCase();
    const dayMap = {
        'lunes': 'Lunes',
        'martes': 'Martes', 
        'miercoles': 'Miercoles',
        'miércoles': 'Miercoles',
        'jueves': 'Jueves',
        'viernes': 'Viernes',
        'sabado': 'Sabado',
        'sábado': 'Sabado',
        'domingo': 'Domingo'
    };
    return dayMap[lower] || d;
  }

  _buildGrid(){
    this.grid.innerHTML = '';
    // corner
    this.grid.appendChild(this._celda('schedule-corner','Hora \\ Día'));
    // headers
    this.daysCanonical.forEach(d => this.grid.appendChild(this._celda('schedule-header', d)));
    // rows
    this.times.forEach(slot => {
      const claseHora = slot.time.endsWith(':00') ? 'schedule-time bold-hour' : 'schedule-time';
      this.grid.appendChild(this._celda(claseHora, slot.display));
      // cells per day with data attributes
      this.daysCanonical.forEach(day => {
        const cel = this._celda('schedule-cell','');
        cel.setAttribute('data-day', day);
        cel.setAttribute('data-time', slot.time);
        cel.setAttribute('data-start-min', slot.startM);
        cel.setAttribute('data-end-min', slot.endM);
        this.grid.appendChild(cel);
      });
    });
  }

  _celda(clase, text){
    const d = document.createElement('div');
    d.className = clase;
    d.textContent = text;
    return d;
  }

  _timeToMinutes(t){
    if(!t) return NaN;
    const parts = String(t).split(':').map(Number);
    if(parts.length >=2) return parts[0]*60 + parts[1];
    return NaN;
  }

  // carga inicial
  async _loadFromApi(){
    this._setStatus('Cargando horario...');
    try {
      const res = await fetch('/horario/api');
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      this._log('=== DATOS RECIBIDOS DEL API ===');
      this._log('Bloques recibidos:', data.bloques ? data.bloques.length : 0);
      this._log('Contenido:', JSON.stringify(data.bloques, null, 2));
      
      if(!data || !Array.isArray(data.bloques) || data.bloques.length===0){
        this._setStatus('No hay cursos en el horario');
        return;
      }

      this._renderBloques(data.bloques);
      this._setStatus(`Horario cargado (${data.bloques.length} cursos)`);
    } catch(e){
      console.error('Error al obtener horario', e);
      this._setStatus('Error de conexión con servidor');
    }
  }

  _setStatus(msg){ 
    const el = document.getElementById('statusMessage'); 
    if(el) el.textContent = msg; 
  }

  // Renderiza bloques
  _renderBloques(bloques){
    this._clearVisual();
    this._log('=== RENDERIZANDO BLOQUES ===');
    bloques.forEach((b, index) => {
      this._log(`Bloque ${index + 1}:`, JSON.stringify(b));
      this._renderBloque(b);
    });
  }

  _clearVisual(){
    this.grid.querySelectorAll('.course-block').forEach(n => n.remove());
    this.grid.querySelectorAll('.schedule-cell').forEach(c => { 
        c.innerHTML=''; 
        c.style.background = '';
    });
  }

  _renderBloque(b){
    const rawDay = b.dia || b.day || '';
    const dayNorm = this._normalizeDay(rawDay);
    
    this._log(`Procesando bloque: ${rawDay} -> ${dayNorm}`);
    this._log(`Horario: ${b.horaInicio} - ${b.horaFin}`);

    const startMin = this._timeToMinutes(this._shortenTime(b.horaInicio));
    const endMin = this._timeToMinutes(this._shortenTime(b.horaFin));
    
    this._log(`Tiempos en minutos: ${startMin} - ${endMin}`);

    if(isNaN(startMin) || isNaN(endMin) || endMin <= startMin) {
      this._log('ERROR: Horario inválido en bloque', b);
      return;
    }

    const selector = `.schedule-cell[data-day="${dayNorm}"]`;
    const dayCells = Array.from(this.grid.querySelectorAll(selector));
    
    this._log(`Celdas encontradas para ${dayNorm}: ${dayCells.length}`);

    if(dayCells.length === 0){
      this._log(`ERROR: No hay celdas para día ${dayNorm}`);
      return;
    }

    const cellsInRange = dayCells.filter(cell => {
      const cellStartMin = parseInt(cell.getAttribute('data-start-min'));
      const cellEndMin = parseInt(cell.getAttribute('data-end-min'));
      return cellStartMin < endMin && cellEndMin > startMin;
    });

    this._log(`Celdas en rango: ${cellsInRange.length}`);

    if(cellsInRange.length === 0){
      this._log('ERROR: Ninguna celda encontrada en el rango');
      return;
    }

    const blockEl = document.createElement('div');
    blockEl.className = 'course-block';
    
    // --- ESTILO VISUAL EXTRA PARA BLOQUES PERSONALES ---
    if(b.nombreCurso === "Personal") {
        blockEl.style.backgroundColor = "#ffc107"; // Un color ámbar
        blockEl.style.color = "#333";
    }
    // --- FIN ESTILO EXTRA ---

    const nombreCurso = b.nombreCurso || b.nombre || 'Curso';
    const docente = b.docente || 'Docente no especificado';
    const codigoSeccion = b.codigoSeccion || 'Código no disponible';
    const horaInicio = this._shortenTime(b.horaInicio);
    const horaFin = this._shortenTime(b.horaFin);

    blockEl.innerHTML = `
      <div class="course-title">${this._truncateText(nombreCurso, 40)}</div>
      <div class="course-info">${this._truncateText(docente, 35)}</div>
      <div class="course-info">Sección: ${codigoSeccion}</div>
      <div class="course-time">${horaInicio} - ${horaFin}</div>
    `;

    blockEl.title = `${nombreCurso}\nDocente: ${docente}\nSección: ${codigoSeccion}\nHorario: ${horaInicio} - ${horaFin}`;

    const firstCell = cellsInRange[0];
    const lastCell = cellsInRange[cellsInRange.length - 1];

    const top = firstCell.offsetTop;
    const left = firstCell.offsetLeft;
    const height = (lastCell.offsetTop + lastCell.offsetHeight) - firstCell.offsetTop;
    const width = firstCell.offsetWidth - 4;

    blockEl.style.position = 'absolute';
    blockEl.style.top = `${top}px`;
    blockEl.style.left = `${left}px`;
    blockEl.style.width = `${width}px`;
    blockEl.style.height = `${height}px`;

    this.grid.appendChild(blockEl);
    this._log(`✓ Bloque renderizado en ${dayNorm} ${horaInicio}-${horaFin}`);
  }

  _truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength - 3) + '...';
  }

  _shortenTime(t){
    if(!t) return t;
    if(typeof t !== 'string') t = String(t);
    const parts = t.split(':');
    return parts.length >= 2 ? `${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}` : t;
  }

  async refresh(){
    await this._loadFromApi();
  }
}

let horarioManager = new HorarioManager();

function actualizarDesdeBackend(){ 
  horarioManager.refresh(); 
}

function limpiarHorario(){
  if(!confirm('¿Seguro que quieres limpiar todo el horario?')) return;
  fetch('/horario/api/clear', { method:'DELETE' })
    .then(r => {
      if(r.ok){
        horarioManager._clearVisual();
        document.getElementById('statusMessage').textContent = 'Horario limpiado';
      } else {
        alert('Error al limpiar horario');
      }
    }).catch(e => { 
      alert('Error al conectar con el servidor'); 
      console.error(e); 
    });
}

function toggleDebug() {
  const debugPanel = document.getElementById('debugPanel');
  debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
}

document.getElementById('form-bloque-personalizado').addEventListener('submit', function(e) {
    e.preventDefault(); // Evitar que la página recargue
    
    const nombre = document.getElementById('bloque-nombre').value;
    const dia = document.getElementById('bloque-dia').value;
    const horaInicio = document.getElementById('bloque-inicio').value;
    const horaFin = document.getElementById('bloque-fin').value;

    // Validación simple de tiempo
    if (horaInicio >= horaFin) {
        alert('La hora de fin debe ser mayor a la hora de inicio.');
        return;
    }

    const bloque = {
        nombre: nombre, // El @RequestBody mapeará esto al 'nombre' del HorarioBloque
        dia: dia,
        horaInicio: horaInicio,
        horaFin: horaFin,
        nombreCurso: "Personal",
        docente: "Personalizado",
        codigoSeccion: "----"
    };

    fetch('/horario/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bloque)
    })
    .then(response => {
        if (response.ok) {
            horarioManager.refresh();
            document.getElementById('form-bloque-personalizado').reset(); // Limpiar el formulario
        } else {
            alert('Error al añadir el bloque.');
        }
    })
    .catch(error => {
        console.error('Error al añadir bloque:', error);
        alert('Error de conexión al añadir bloque.');
    });
});

</script>
</body>
</html>